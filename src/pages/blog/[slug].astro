---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import { Calendar, Tag, ArrowLeft, Clock } from 'phosphor-svelte';
import Badge from '@/components/ui/badge.svelte';
import RelatedPosts from '@/components/RelatedPosts.svelte';
import { getReadingTime, getRelatedPosts } from '@/lib/blog-utils';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog', ({ data }) => {
    return import.meta.env.PROD ? data.draft !== true : true;
  });
  
  return blogEntries.map(entry => ({
    params: { slug: entry.slug },
    props: { entry, allPosts: blogEntries },
  }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
  allPosts: CollectionEntry<'blog'>[];
}

const { entry, allPosts } = Astro.props;
const { Content } = await entry.render();

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}

const readingTime = getReadingTime(entry.body);
const relatedPosts = getRelatedPosts(entry, allPosts);

// Schema.org JSON-LD
const schema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": entry.data.title,
  "description": entry.data.description,
  "datePublished": entry.data.date.toISOString(),
  "author": {
    "@type": "Person",
    "name": entry.data.author
  },
  "image": entry.data.coverImage ? `https://napolitain.github.io${entry.data.coverImage}` : undefined
};
---

<Layout 
  title={`${entry.data.title} - Napolitain`} 
  description={entry.data.description}
  image={entry.data.coverImage}
  type="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  
  <div class="min-h-screen">
    <!-- Back to Blog -->
    <div class="max-w-3xl mx-auto px-6 pt-20">
      <a 
        href="/blog" 
        class="inline-flex items-center gap-2 text-muted-foreground hover:text-primary transition-colors mb-12"
      >
        <ArrowLeft client:load size={20} />
        Back to Blog
      </a>
    </div>

    <!-- Article Header -->
    <article class="max-w-3xl mx-auto px-6 py-20">
      <header class="mb-16 space-y-8">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold text-foreground leading-tight font-sans">
          {entry.data.title}
        </h1>
        
        <p class="text-xl text-muted-foreground leading-relaxed font-serif">
          {entry.data.description}
        </p>

        <div class="flex flex-wrap items-center gap-6 text-sm text-muted-foreground font-sans">
          <div class="flex items-center gap-2">
            <Calendar client:load size={16} />
            <time datetime={entry.data.date.toISOString()}>
              {formatDate(entry.data.date)}
            </time>
          </div>

          <div class="flex items-center gap-2">
            <Clock client:load size={16} />
            <span>{readingTime}</span>
          </div>

          {entry.data.tags.length > 0 && (
            <div class="flex items-center gap-2">
              <Tag client:load size={16} />
              <div class="flex flex-wrap gap-2">
                {entry.data.tags.map((tag) => (
                  <Badge client:load variant="secondary" class="text-xs">
                    {tag}
                  </Badge>
                ))}
              </div>
            </div>
          )}
        </div>
      </header>

    <!-- Article Content -->
    <!-- Article Content -->
      <div class="prose prose-xl prose-slate dark:prose-invert max-w-3xl mx-auto whitespace-pre-wrap font-serif">
        <Content />
      </div>

      <RelatedPosts client:load posts={relatedPosts.map(post => ({
        title: post.data.title,
        description: post.data.description,
        date: post.data.date,
        tags: post.data.tags,
        slug: post.slug,
        readingTime: getReadingTime(post.body)
      }))} />
    </article>

    <!-- Footer -->
    <footer class="py-16 px-8 border-t border-border mt-20">
      <div class="max-w-6xl mx-auto text-center text-sm text-muted-foreground">
        <p>Â© {new Date().getFullYear()} Napolitain. Built with Astro, Svelte & TypeScript.</p>
      </div>
    </footer>
  </div>
</Layout>
